<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LUMOS ELITE | Secure Access</title>
    
    <!-- React Core -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Estilos y Utilidades -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            black: '#050505',
                            dark: '#0A0A0A',
                            surface: '#121212',
                            gold: '#C5A059',
                            goldLight: '#E5C585',
                            muted: '#525252',
                            danger: '#991B1B',
                            success: '#10B981'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Cinzel', 'serif']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1)',
                        'slide-in': 'slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1)'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: 0, transform: 'translateY(10px)' }, '100%': { opacity: 1, transform: 'translateY(0)' } },
                        slideIn: { '0%': { transform: 'translateX(100%)' }, '100%': { transform: 'translateX(0)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #050505; color: #E5E5E5; -webkit-font-smoothing: antialiased; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0A0A0A; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #C5A059; }
        .glass-panel {
            background: rgba(18, 18, 18, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        #loader-overlay {
            position: fixed; inset: 0; z-index: 9999; background: #050505; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        /* Ocultar input password eye default */
        input[type="password"]::-ms-reveal,
        input[type="password"]::-ms-clear { display: none; }
    </style>
</head>
<body>
    <div id="loader-overlay">
        <div class="w-16 h-16 border-t-2 border-brand-gold rounded-full animate-spin mb-4"></div>
        <p class="text-brand-gold text-xs tracking-[0.3em] font-serif animate-pulse">ENCRIPTANDO CONEXIÃ“N...</p>
    </div>

    <div id="root"></div>

    <script type="module">
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, addDoc, deleteDoc, query, where, onSnapshot, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.FirebaseDS = {
            initializeApp, deleteApp, getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged,
            getFirestore, collection, doc, getDoc, setDoc, updateDoc, addDoc, deleteDoc, query, where, onSnapshot, serverTimestamp, orderBy
        };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        const initReactApp = () => {
            document.getElementById('loader-overlay').style.display = 'none';
            const { initializeApp, deleteApp, getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, getFirestore, collection, doc, getDoc, setDoc, updateDoc, addDoc, deleteDoc, query, where, onSnapshot, serverTimestamp, orderBy } = window.FirebaseDS;

            // --- CONFIGURACIÃ“N FIREBASE (Lumos DWS) ---
            const firebaseConfig = {
                apiKey: "AIzaSyD-EXCm7GInlVPs35kCO0K4352TwYOe6tc",
                authDomain: "lumos-dws.firebaseapp.com",
                projectId: "lumos-dws",
                storageBucket: "lumos-dws.firebasestorage.app",
                messagingSenderId: "234532434316",
                appId: "1:234532434316:web:88f8c799f193e3e18726a9"
            };
            
            // --- ðŸ›‘ CONFIGURACIÃ“N MAESTRA ðŸ›‘ ---
            const MASTER_KEY = "Admin01"; // <--- CLAVE DEL MASTER 
            const MASTER_PASS = "Sup2025"; // <--- CONTRASEÃ‘A DEL MASTER
            const HIDDEN_DOMAIN = "@lumos.private"; // Dominio invisible
            // ----------------------------------------

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            const Security = {
                getDeviceId: () => {
                    let id = localStorage.getItem('lumos_elite_id');
                    if (!id) { 
                        id = crypto.randomUUID(); 
                        localStorage.setItem('lumos_elite_id', id); 
                    }
                    return id;
                },
                formatMoney: (amount) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount),
                formatDate: (timestamp) => {
                    if(!timestamp) return 'Pendiente...';
                    return new Date(timestamp.seconds * 1000).toLocaleDateString("es-MX", { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' });
                },
                cleanUsername: (email) => email ? email.replace(HIDDEN_DOMAIN, '') : ''
            };

            const Loader = ({ text }) => (
                <div className="fixed inset-0 bg-brand-black flex flex-col items-center justify-center z-50">
                    <div className="w-16 h-16 border-t-2 border-brand-gold rounded-full animate-spin mb-4"></div>
                    <p className="text-brand-gold text-xs tracking-[0.3em] font-serif animate-pulse">{text || 'PROCESANDO...'}</p>
                </div>
            );

            const LoginScreen = ({ onLogin }) => {
                const [username, setUsername] = React.useState('');
                const [pass, setPass] = React.useState('');
                const [loading, setLoading] = React.useState(false);
                const [error, setError] = React.useState(null);
                const currentDeviceId = Security.getDeviceId(); // ID actual del navegador

                const processLogin = async (userAuth, isNewUser = false) => {
                    const userRef = doc(db, 'users', userAuth.uid);
                    const userSnap = await getDoc(userRef);
                    const inputUser = Security.cleanUsername(userAuth.email);

                    if (!userSnap.exists()) {
                        // CreaciÃ³n automÃ¡tica SOLO para el MASTER inicial
                        const initialRole = (inputUser.toUpperCase() === MASTER_KEY.toUpperCase()) ? 'admin' : 'client';
                        await setDoc(userRef, {
                            username: inputUser,
                            email: userAuth.email, 
                            role: initialRole, 
                            registeredDeviceId: currentDeviceId,
                            status: 'active',
                            createdAt: serverTimestamp()
                        });
                        onLogin(userAuth, initialRole);
                    } else {
                        const data = userSnap.data();
                        if (data.status !== 'active') throw new Error("Acceso Revocado.");
                        
                        // LÃ“GICA DE VALIDACIÃ“N DE DISPOSITIVO MEJORADA
                        // Si es ADMIN, NO verificamos el dispositivo (Paso Libre)
                        if (data.role === 'admin') {
                            // Opcional: Actualizar el Ãºltimo dispositivo usado por el admin solo para registro
                            await updateDoc(userRef, { lastDeviceId: currentDeviceId });
                            onLogin(userAuth, 'admin');
                            return;
                        }

                        // Si es CLIENTE, aplicamos seguridad estricta
                        if (data.registeredDeviceId && data.registeredDeviceId !== currentDeviceId) {
                            await signOut(auth); 
                            throw new Error(`Dispositivo no autorizado. (ID Esperado: ...${data.registeredDeviceId.slice(-4)}, ID Actual: ...${currentDeviceId.slice(-4)})`);
                        }
                        
                        // Vincular dispositivo si estaba libre
                        if (!data.registeredDeviceId) await updateDoc(userRef, { registeredDeviceId: currentDeviceId });
                        
                        onLogin(userAuth, data.role);
                    }
                };

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    setLoading(true); setError(null);
                    
                    // VALIDACIÃ“N DE SEGURIDAD LOCAL PARA MASTER
                    if (username.trim().toUpperCase() === MASTER_KEY.toUpperCase()) {
                        if (pass !== MASTER_PASS) {
                            setError("Credenciales Maestras Incorrectas.");
                            setLoading(false);
                            return;
                        }
                    }

                    const fullEmail = username.trim() + HIDDEN_DOMAIN;
                    
                    try {
                        try {
                            const cred = await signInWithEmailAndPassword(auth, fullEmail, pass);
                            await processLogin(cred.user);
                        } catch (loginErr) {
                            if (loginErr.code === 'auth/user-not-found' || loginErr.code === 'auth/invalid-credential') {
                                // Bootstrap Master
                                if (username.trim().toUpperCase() === MASTER_KEY.toUpperCase()) {
                                    try {
                                        const newCred = await createUserWithEmailAndPassword(auth, fullEmail, pass);
                                        await processLogin(newCred.user, true);
                                    } catch (createErr) {
                                        if(createErr.code === 'auth/email-already-in-use') throw new Error("Clave incorrecta.");
                                        throw createErr;
                                    }
                                } else {
                                    throw new Error("Usuario no registrado. Solicite alta al Master.");
                                }
                            } else {
                                throw loginErr;
                            }
                        }
                    } catch (err) { 
                        console.error(err);
                        let msg = err.message;
                        if (err.code === 'auth/wrong-password') msg = "Clave de acceso incorrecta.";
                        setError(msg); 
                        setLoading(false); 
                    }
                };

                return (
                    <div className="min-h-screen flex items-center justify-center bg-[url('https://images.unsplash.com/photo-1497366216548-37526070297c?auto=format&fit=crop&w=1920&q=80')] bg-cover bg-center">
                        <div className="absolute inset-0 bg-black/90 backdrop-blur-sm"></div>
                        <div className="relative z-10 w-full max-w-md p-10 glass-panel rounded-2xl shadow-2xl animate-fade-in border border-white/5">
                            <div className="text-center mb-10">
                                <div className="w-16 h-16 bg-brand-gold/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-brand-gold/30">
                                    <i className="fas fa-shield-alt text-3xl text-brand-gold"></i>
                                </div>
                                <h1 className="font-serif text-3xl text-white tracking-wide">LUMOS <span className="text-brand-gold">SECURE</span></h1>
                                <p className="text-brand-muted text-[10px] uppercase tracking-[0.3em] mt-2">Acceso Encriptado</p>
                            </div>
                            
                            {error && (
                                <div className="mb-6 p-3 bg-red-900/20 border-l-2 border-red-500 text-red-200 text-xs flex items-center gap-2 animate-pulse">
                                    <i className="fas fa-exclamation-circle"></i> {error}
                                </div>
                            )}
                            
                            <form onSubmit={handleSubmit} className="space-y-6">
                                <div className="group relative">
                                    <label className="absolute -top-2 left-2 bg-black px-1 text-[10px] text-brand-gold uppercase tracking-wider">Usuario / Clave</label>
                                    <input 
                                        type="text" 
                                        value={username} onChange={e=>setUsername(e.target.value.toUpperCase())}
                                        className="w-full bg-transparent border border-white/20 rounded-lg p-4 text-white placeholder-gray-600 focus:border-brand-gold focus:outline-none font-mono text-center tracking-widest uppercase transition-colors"
                                        placeholder="EJ: CLIENTE01" required 
                                    />
                                </div>
                                <div className="group relative">
                                    <label className="absolute -top-2 left-2 bg-black px-1 text-[10px] text-brand-gold uppercase tracking-wider">Clave de Acceso</label>
                                    <input 
                                        type="password" 
                                        value={pass} onChange={e=>setPass(e.target.value)}
                                        className="w-full bg-transparent border border-white/20 rounded-lg p-4 text-white placeholder-gray-600 focus:border-brand-gold focus:outline-none font-mono text-center tracking-widest transition-colors"
                                        placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required 
                                    />
                                </div>
                                <button disabled={loading} className="w-full bg-gradient-to-r from-brand-gold to-[#a18241] text-brand-black font-bold py-4 rounded-lg hover:shadow-[0_0_20px_rgba(197,160,89,0.2)] transition-all transform active:scale-[0.99] mt-2 text-xs tracking-widest uppercase">
                                    {loading ? 'Verificando...' : 'Autenticar Dispositivo'}
                                </button>
                            </form>
                            
                            <div className="mt-8 pt-6 border-t border-white/5 text-center">
                                <p className="text-[10px] text-brand-muted font-mono" title={currentDeviceId}>
                                    TERMINAL ID: <span className="text-gray-500 hover:text-white transition-colors cursor-help">{currentDeviceId.substring(0,16)}...</span>
                                </p>
                            </div>
                        </div>
                    </div>
                );
            };

            // --- MANAGER DE USUARIOS (Con Alta Manual) ---
            const UserManager = () => {
                const [users, setUsers] = React.useState([]);
                const [newKey, setNewKey] = React.useState('');
                const [newPass, setNewPass] = React.useState('');
                const [creating, setCreating] = React.useState(false);

                React.useEffect(() => {
                    return onSnapshot(collection(db, 'users'), (s) => setUsers(s.docs.map(d => ({id: d.id, ...d.data()}))));
                }, []);

                const handleCreateUser = async (e) => {
                    e.preventDefault();
                    setCreating(true);
                    
                    let secondaryApp = null;
                    try {
                        const email = newKey.trim() + HIDDEN_DOMAIN;
                        secondaryApp = initializeApp(firebaseConfig, "SecondaryApp");
                        const secondaryAuth = getAuth(secondaryApp);
                        
                        const userCred = await createUserWithEmailAndPassword(secondaryAuth, email, newPass);
                        const uid = userCred.user.uid;
                        
                        await setDoc(doc(db, 'users', uid), {
                            username: newKey.toUpperCase(),
                            email: email,
                            role: 'client', 
                            registeredDeviceId: null, 
                            status: 'active',
                            createdAt: serverTimestamp()
                        });
                        
                        alert(`Usuario ${newKey.toUpperCase()} creado exitosamente.`);
                        setNewKey('');
                        setNewPass('');
                        
                    } catch (error) {
                        console.error(error);
                        if (error.code === 'auth/email-already-in-use') alert("Error: Esa Clave de Usuario ya existe.");
                        else alert("Error al crear usuario: " + error.message);
                    } finally {
                        if (secondaryApp) deleteApp(secondaryApp); 
                        setCreating(false);
                    }
                };

                const toggleRole = async (userId, currentRole) => {
                    const newRole = currentRole === 'admin' ? 'client' : 'admin';
                    if(confirm(`Â¿Cambiar rol a ${newRole}?`)) await updateDoc(doc(db, 'users', userId), { role: newRole });
                };

                const resetDevice = async (userId) => {
                    if(confirm("Â¿Resetear huella de dispositivo? El usuario podrÃ¡ vincular un nuevo equipo.")) await updateDoc(doc(db, 'users', userId), { registeredDeviceId: null });
                };

                return (
                    <div className="space-y-8">
                        {/* Formulario de Alta */}
                        <div className="glass-panel p-6 rounded-xl border-t border-brand-gold">
                            <h3 className="text-sm text-brand-gold mb-4 font-mono uppercase tracking-wider flex items-center gap-2">
                                <i className="fas fa-user-plus"></i> Alta de Nuevo Cliente
                            </h3>
                            <form onSubmit={handleCreateUser} className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <div>
                                    <label className="text-[10px] text-gray-500 uppercase">Clave Ãšnica (Usuario)</label>
                                    <input 
                                        type="text" 
                                        placeholder="EJ: CLIENTE_NUEVO" 
                                        value={newKey} onChange={e=>setNewKey(e.target.value.toUpperCase())} 
                                        className="w-full bg-black/50 border border-white/10 rounded p-2 text-white text-sm outline-none focus:border-brand-gold font-mono uppercase" 
                                        required 
                                    />
                                </div>
                                <div>
                                    <label className="text-[10px] text-gray-500 uppercase">ContraseÃ±a Temporal</label>
                                    <input 
                                        type="text" 
                                        placeholder="ContraseÃ±a" 
                                        value={newPass} onChange={e=>setNewPass(e.target.value)} 
                                        className="w-full bg-black/50 border border-white/10 rounded p-2 text-white text-sm outline-none focus:border-brand-gold" 
                                        required 
                                    />
                                </div>
                                <button disabled={creating} className="bg-brand-gold text-black font-bold py-2 px-4 rounded hover:bg-white transition-colors text-xs uppercase tracking-wider h-10">
                                    {creating ? 'Creando...' : 'Registrar Usuario'}
                                </button>
                            </form>
                        </div>

                        {/* Lista de Usuarios */}
                        <div className="glass-panel rounded-xl overflow-hidden">
                            <table className="w-full text-left text-sm text-gray-400">
                                <thead className="bg-white/5 text-white uppercase text-xs">
                                    <tr><th className="p-4">Usuario</th><th className="p-4">Rol</th><th className="p-4">Estado Dispositivo</th><th className="p-4">Acciones</th></tr>
                                </thead>
                                <tbody className="divide-y divide-white/5">
                                    {users.map(u => (
                                        <tr key={u.id} className="hover:bg-white/5 transition-colors">
                                            <td className="p-4 text-white font-mono tracking-wide">
                                                {u.username || Security.cleanUsername(u.email)}
                                                {Security.cleanUsername(u.email) === MASTER_KEY && <i className="fas fa-crown text-brand-gold ml-2"></i>}
                                            </td>
                                            <td className="p-4"><span className={`px-2 py-1 rounded text-[10px] uppercase border ${u.role==='admin'?'border-purple-500 text-purple-400':'border-gray-600 text-gray-400'}`}>{u.role}</span></td>
                                            <td className="p-4 text-xs">
                                                {u.registeredDeviceId ? 
                                                    <span className="text-green-500 font-mono" title={u.registeredDeviceId}>
                                                        {u.registeredDeviceId.substring(0,8)}... <i className="fas fa-check-circle"></i>
                                                    </span> 
                                                    : 
                                                    <span className="text-yellow-500 animate-pulse">Sin VinculaciÃ³n</span>
                                                }
                                            </td>
                                            <td className="p-4 flex gap-2">
                                                {Security.cleanUsername(u.email) !== MASTER_KEY && (
                                                    <>
                                                        <button onClick={()=>toggleRole(u.id, u.role)} className="w-8 h-8 rounded bg-white/5 hover:bg-white/20 text-white" title="Cambiar Rol"><i className="fas fa-user-tag"></i></button>
                                                        <button onClick={()=>resetDevice(u.id)} className="w-8 h-8 rounded bg-white/5 hover:bg-white/20 text-white" title="Desvincular Dispositivo"><i className="fas fa-mobile-alt"></i></button>
                                                    </>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            const ProductManager = () => {
                const [products, setProducts] = React.useState([]);
                const [newProd, setNewProd] = React.useState({ name: '', price: '', category: 'Hardware', image: '', stock: 1 });
                const [loading, setLoading] = React.useState(false);

                React.useEffect(() => {
                    return onSnapshot(collection(db, 'products'), (s) => setProducts(s.docs.map(d => ({id: d.id, ...d.data()}))));
                }, []);

                const handleAdd = async (e) => {
                    e.preventDefault(); setLoading(true);
                    try { await addDoc(collection(db, 'products'), { ...newProd, price: Number(newProd.price), stock: Number(newProd.stock), createdAt: serverTimestamp() }); setNewProd({ name: '', price: '', category: 'Hardware', image: '', stock: 1 }); } catch(e) { alert("Error"); }
                    setLoading(false);
                };

                const handleDelete = async (id) => { if(confirm("Â¿Eliminar?")) await deleteDoc(doc(db, 'products', id)); };

                return (
                    <div className="space-y-6">
                        <div className="glass-panel p-6 rounded-xl border-t border-brand-success">
                            <h3 className="text-sm text-brand-success mb-4 font-mono uppercase tracking-wider">Alta de Inventario</h3>
                            <form onSubmit={handleAdd} className="grid grid-cols-1 md:grid-cols-5 gap-4">
                                <input placeholder="Nombre Item" value={newProd.name} onChange={e=>setNewProd({...newProd, name: e.target.value})} className="md:col-span-2 bg-black/50 border border-white/10 rounded p-2 text-white text-sm outline-none focus:border-brand-success" required />
                                <input placeholder="URL Imagen" value={newProd.image} onChange={e=>setNewProd({...newProd, image: e.target.value})} className="bg-black/50 border border-white/10 rounded p-2 text-white text-sm outline-none focus:border-brand-success" required />
                                <select value={newProd.category} onChange={e=>setNewProd({...newProd, category: e.target.value})} className="bg-black/50 border border-white/10 rounded p-2 text-white text-sm outline-none"><option>Hardware</option><option>Software</option><option>Servicios</option><option>Infraestructura</option></select>
                                <input type="number" placeholder="Precio" value={newProd.price} onChange={e=>setNewProd({...newProd, price: e.target.value})} className="bg-black/50 border border-white/10 rounded p-2 text-white text-sm outline-none focus:border-brand-success" required />
                                <button disabled={loading} className="md:col-span-5 bg-brand-success/10 text-brand-success border border-brand-success hover:bg-brand-success hover:text-black py-2 rounded uppercase text-xs font-bold transition">{loading ? 'Procesando...' : 'Registrar Item'}</button>
                            </form>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {products.map(p => (
                                <div key={p.id} className="glass-panel p-3 rounded flex gap-3 items-center group relative">
                                    <img src={p.image} className="w-12 h-12 rounded object-cover bg-black" onError={(e)=>e.target.src='https://via.placeholder.com/50'} />
                                    <div className="flex-1 overflow-hidden"><p className="text-white text-sm truncate">{p.name}</p><p className="text-brand-gold text-xs">{Security.formatMoney(p.price)}</p></div>
                                    <button onClick={() => handleDelete(p.id)} className="absolute top-2 right-2 text-gray-600 hover:text-red-500 transition"><i className="fas fa-times"></i></button>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const StoreApp = ({ user, role, onLogout }) => {
                const [view, setView] = React.useState('store'); 
                const [products, setProducts] = React.useState([]);
                const [cart, setCart] = React.useState([]);
                const [cartOpen, setCartOpen] = React.useState(false);
                const username = Security.cleanUsername(user.email);

                React.useEffect(() => onSnapshot(collection(db, 'products'), (s) => setProducts(s.docs.map(d => ({id: d.id, ...d.data()})))), []);

                const addToCart = (p) => { setCart([...cart, p]); setCartOpen(true); };
                const checkout = async () => {
                    if(!cart.length) return;
                    await addDoc(collection(db, "orders"), { userId: user.uid, username: username, items: cart, total: cart.reduce((a,b)=>a+b.price,0), status: 'Pendiente', createdAt: serverTimestamp(), deviceId: Security.getDeviceId() });
                    setCart([]); setCartOpen(false); setView('orders');
                };

                return (
                    <div className="min-h-screen bg-brand-dark flex flex-col md:flex-row">
                        <aside className="hidden md:flex flex-col w-64 glass-panel border-r border-white/5 h-screen sticky top-0 z-30 p-6">
                            <h2 className="font-serif text-2xl text-white tracking-widest mb-8">LUMOS</h2>
                            <nav className="space-y-2">
                                <button onClick={()=>setView('store')} className={`w-full text-left p-3 rounded text-sm ${view==='store'?'bg-white/5 text-brand-gold':'text-gray-400'}`}><i className="fas fa-th-large w-5"></i> CatÃ¡logo</button>
                                <button onClick={()=>setView('orders')} className={`w-full text-left p-3 rounded text-sm ${view==='orders'?'bg-white/5 text-brand-gold':'text-gray-400'}`}><i className="fas fa-clock w-5"></i> Mis Pedidos</button>
                                {role === 'admin' && (
                                    <>
                                        <div className="pt-4 mt-4 border-t border-white/5 text-[10px] text-gray-500 uppercase tracking-widest mb-2">AdministraciÃ³n</div>
                                        <button onClick={()=>setView('inventory')} className={`w-full text-left p-3 rounded text-sm ${view==='inventory'?'bg-brand-success/10 text-brand-success':'text-gray-400'}`}><i className="fas fa-boxes w-5"></i> Inventario</button>
                                        <button onClick={()=>setView('users')} className={`w-full text-left p-3 rounded text-sm ${view==='users'?'bg-purple-500/20 text-purple-400':'text-gray-400'}`}><i className="fas fa-users w-5"></i> Usuarios</button>
                                    </>
                                )}
                            </nav>
                            <div className="mt-auto pt-6 border-t border-white/5">
                                <div className="text-xs text-brand-gold font-mono mb-2 flex items-center gap-2"><div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> {username}</div>
                                <button onClick={onLogout} className="text-red-400 text-xs hover:text-red-300">Cerrar Enlace</button>
                            </div>
                        </aside>

                        <main className="flex-1 p-6 md:p-10 pt-20 md:pt-10 overflow-y-auto h-screen">
                            <div className="md:hidden fixed top-0 left-0 right-0 glass-panel p-4 flex justify-between items-center z-40">
                                <span className="font-serif text-brand-gold">LUMOS</span>
                                <div className="flex gap-4">
                                    <button onClick={()=>setCartOpen(true)} className="text-white relative"><i className="fas fa-shopping-bag"></i>{cart.length>0 && <span className="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full"></span>}</button>
                                    {role==='admin' && <button onClick={()=>setView('inventory')} className="text-brand-success"><i className="fas fa-boxes"></i></button>}
                                </div>
                            </div>

                            {view === 'store' && (
                                <div className="animate-fade-in max-w-6xl mx-auto">
                                    <h1 className="text-3xl font-serif text-white mb-6">ColecciÃ³n</h1>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        {products.length === 0 ? <p className="text-gray-500 col-span-3 text-center py-20">Sistema en lÃ­nea. Esperando carga de inventario.</p> : products.map(p => (
                                            <div key={p.id} className="glass-panel rounded-xl overflow-hidden group hover:border-brand-gold/30 transition-all duration-300">
                                                <div className="h-48 overflow-hidden relative">
                                                    <img src={p.image} className="w-full h-full object-cover transition duration-700 group-hover:scale-110" onError={(e)=>e.target.src='https://via.placeholder.com/300?text=No+Image'}/>
                                                    <div className="absolute top-2 left-2 bg-black/60 backdrop-blur px-2 py-1 text-[10px] text-white rounded border border-white/10">{p.category}</div>
                                                </div>
                                                <div className="p-5">
                                                    <h3 className="text-white font-medium">{p.name}</h3>
                                                    <div className="flex justify-between items-center mt-4">
                                                        <span className="text-brand-gold text-lg font-serif">{Security.formatMoney(p.price)}</span>
                                                        <button onClick={()=>addToCart(p)} className="w-8 h-8 rounded-full bg-white/10 hover:bg-brand-gold hover:text-black text-white flex items-center justify-center transition"><i className="fas fa-plus"></i></button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {view === 'inventory' && role === 'admin' && <div className="animate-fade-in max-w-5xl mx-auto"><h1 className="text-3xl font-serif text-white mb-6">Inventario</h1><ProductManager /></div>}
                            {view === 'users' && role === 'admin' && <div className="animate-fade-in max-w-5xl mx-auto"><h1 className="text-3xl font-serif text-white mb-6">Usuarios</h1><UserManager /></div>}
                        </main>

                        {cartOpen && (
                            <div className="fixed inset-0 z-50 flex justify-end">
                                <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={()=>setCartOpen(false)}></div>
                                <div className="relative w-full max-w-md bg-brand-surface h-full shadow-2xl animate-slide-in border-l border-white/10 flex flex-col p-6">
                                    <div className="flex justify-between items-center mb-6"><h2 className="font-serif text-white text-xl">Bolsa Segura</h2><button onClick={()=>setCartOpen(false)} className="text-gray-400"><i className="fas fa-times"></i></button></div>
                                    <div className="flex-1 overflow-y-auto space-y-4">
                                        {cart.map((item,i)=>(<div key={i} className="flex gap-4 p-3 glass-panel rounded"><img src={item.image} className="w-12 h-12 rounded object-cover"/><div className="flex-1"><p className="text-white text-sm">{item.name}</p><p className="text-brand-gold text-xs">{Security.formatMoney(item.price)}</p></div></div>))}
                                    </div>
                                    <button onClick={checkout} className="w-full bg-brand-gold text-black font-bold py-3 rounded mt-4 uppercase tracking-widest text-xs">Confirmar Pedido {Security.formatMoney(cart.reduce((a,b)=>a+b.price,0))}</button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const App = () => {
                const [user, setUser] = React.useState(null);
                const [role, setRole] = React.useState(null);
                const [loading, setLoading] = React.useState(true);

                React.useEffect(() => onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        const snap = await getDoc(doc(db, "users", u.uid));
                        if(snap.exists()) {
                            const d = snap.data();
                            
                            // VALIDACIÃ“N DE SESIÃ“N ACTIVA (Permisiva para admin)
                            if (d.role !== 'admin' && d.registeredDeviceId && d.registeredDeviceId !== Security.getDeviceId()) {
                                await signOut(auth); 
                                setUser(null); 
                            } else { 
                                setUser(u); 
                                setRole(d.role); 
                            }
                        } else { setUser(u); } 
                    } else { setUser(null); }
                    setLoading(false);
                }), []);

                if (loading) return <Loader />;
                if (!user) return <LoginScreen onLogin={(u, r) => { setUser(u); setRole(r); }} />;
                return <StoreApp user={user} role={role} onLogout={() => signOut(auth)} />;
            };

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        };

        if (window.FirebaseDS) initReactApp(); else window.addEventListener('firebase-ready', initReactApp);
    </script>
</body>
</html>
