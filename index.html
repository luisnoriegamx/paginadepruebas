<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumos Elite Store | Acceso Exclusivo</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        elite: {
                            900: '#0a0a0a', // Fondo casi negro
                            800: '#171717', // Tarjetas oscuras
                            accent: '#D4AF37', // Dorado metálico
                            text: '#E5E5E5',
                            mute: '#737373'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif']
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:wght@700&display=swap');
        body { background-color: #0a0a0a; color: #E5E5E5; }
        .gold-gradient { background: linear-gradient(135deg, #D4AF37 0%, #C5A028 100%); }
        .glass { background: rgba(23, 23, 23, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
        /* Animaciones */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. CONFIGURACIÓN FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, addDoc, query, where, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAWb9rW9iJluudZksJpVAgrB6PG27m4Tqg",
            authDomain: "lumos-assist-39e09.firebaseapp.com",
            projectId: "lumos-assist-39e09",
            storageBucket: "lumos-assist-39e09.firebasestorage.app",
            messagingSenderId: "525173322066",
            appId: "1:525173322066:web:5d0eb9db67d6cb11cd4a8b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 2. UTILIDADES DE SEGURIDAD (ELITE SECURITY) ---
        
        // Genera o recupera un ID único para este navegador/dispositivo
        const getLocalDeviceId = () => {
            let deviceId = localStorage.getItem('elite_device_id');
            if (!deviceId) {
                deviceId = crypto.randomUUID();
                localStorage.setItem('elite_device_id', deviceId);
            }
            return deviceId;
        };

        // Formato de moneda
        const formatMoney = (amount) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount);

        // --- 3. COMPONENTES DE LA UI ---

        const Loading = () => (
            <div className="min-h-screen flex items-center justify-center bg-elite-900">
                <div className="text-center">
                    <i className="fas fa-circle-notch fa-spin text-elite-accent text-4xl mb-4"></i>
                    <p className="text-elite-mute tracking-widest uppercase text-xs">Verificando Credenciales...</p>
                </div>
            </div>
        );

        // --- PANTALLA DE LOGIN CON SEGURIDAD DE DISPOSITIVO ---
        const Login = ({ onLogin }) => {
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [error, setError] = React.useState('');
            const [loading, setLoading] = React.useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                try {
                    // 1. Autenticación Firebase
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    // 2. Verificación de Seguridad en Firestore
                    const userDocRef = doc(db, 'users', user.uid);
                    const userDoc = await getDoc(userDocRef);

                    if (!userDoc.exists()) {
                        // AUTO-REGISTRO SOLO PARA DEMO (Primer acceso crea la cuenta y la ata al dispositivo)
                        const currentDeviceId = getLocalDeviceId();
                        await setDoc(userDocRef, {
                            email: user.email,
                            role: 'client', 
                            registeredDeviceId: currentDeviceId,
                            name: 'Socio Elite',
                            status: 'active',
                            createdAt: serverTimestamp()
                        });
                        onLogin(user, 'client');
                    } else {
                        const userData = userDoc.data();
                        
                        // A. Verificar si está activo
                        if (userData.status !== 'active') throw new Error("Cuenta suspendida. Contacte a Concierge.");

                        // B. LÓGICA DE DISPOSITIVO ÚNICO (Huella Digital)
                        const currentDeviceId = getLocalDeviceId();
                        
                        // Si no tiene dispositivo registrado (primera vez), lo registramos
                        if (!userData.registeredDeviceId) {
                            await updateDoc(userDocRef, { registeredDeviceId: currentDeviceId });
                        } 
                        // Si tiene dispositivo, verificamos que coincida
                        else if (userData.registeredDeviceId !== currentDeviceId) {
                            // BLOQUEO ELITE
                            await signOut(auth);
                            throw new Error("ACCESO DENEGADO: Dispositivo no autorizado. Esta cuenta está vinculada a otro terminal.");
                        }

                        onLogin(user, userData.role || 'client');
                    }

                } catch (err) {
                    console.error(err);
                    setError(err.message.replace("Firebase: ", ""));
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-[url('https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?q=80&w=2070&auto=format&fit=crop')] bg-cover bg-center">
                    <div className="absolute inset-0 bg-black/80"></div>
                    <div className="relative z-10 w-full max-w-md p-8 glass rounded-xl shadow-2xl border-t-4 border-elite-accent">
                        <div className="text-center mb-8">
                            <h1 className="font-serif text-3xl text-elite-accent mb-2">LUMOS ELITE</h1>
                            <p className="text-elite-mute text-xs uppercase tracking-[0.2em]">Acceso Exclusivo para Socios</p>
                        </div>

                        <form onSubmit={handleLogin} className="space-y-6">
                            <div>
                                <label className="block text-xs text-elite-accent uppercase mb-2">Credencial de Acceso</label>
                                <input 
                                    type="email" 
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full bg-elite-900/50 border border-elite-800 text-white p-3 rounded focus:border-elite-accent focus:outline-none transition-colors"
                                    placeholder="usuario@elite.com"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-xs text-elite-accent uppercase mb-2">Llave de Seguridad</label>
                                <input 
                                    type="password" 
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full bg-elite-900/50 border border-elite-800 text-white p-3 rounded focus:border-elite-accent focus:outline-none transition-colors"
                                    placeholder="••••••••"
                                    required
                                />
                            </div>

                            {error && (
                                <div className="p-3 bg-red-900/20 border border-red-900 text-red-400 text-xs text-center rounded">
                                    <i className="fas fa-lock mr-2"></i> {error}
                                </div>
                            )}

                            <button 
                                disabled={loading}
                                className="w-full gold-gradient text-black font-bold py-3 rounded hover:opacity-90 transition-opacity uppercase text-xs tracking-wider"
                            >
                                {loading ? 'Autenticando...' : 'Ingresar al Portal'}
                            </button>
                        </form>
                        
                        <div className="mt-6 text-center">
                            <p className="text-[10px] text-elite-mute">
                                <i className="fas fa-shield-alt mr-1"></i> 
                                Acceso protegido por huella digital de dispositivo.
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // --- DASHBOARD DE LA TIENDA ---
        const Store = ({ user, role, onLogout }) => {
            const [view, setView] = React.useState('products'); // products, cart, history, admin
            const [products, setProducts] = React.useState([]);
            const [cart, setCart] = React.useState([]);
            const [orders, setOrders] = React.useState([]);

            // Datos Mock de Productos Elite
            const MOCK_PRODUCTS = [
                { id: 1, name: "Servidor Rack Xiaomi Elite", price: 45000, cat: "Infraestructura", img: "https://images.unsplash.com/photo-1558494949-ef010cbdcc31?auto=format&fit=crop&w=800&q=80" },
                { id: 2, name: "Consultoría TI Premium (10h)", price: 15000, cat: "Servicios", img: "https://images.unsplash.com/photo-1553877606-3c66952ee013?auto=format&fit=crop&w=800&q=80" },
                { id: 3, name: "Licencia Software CRM", price: 8500, cat: "Software", img: "https://images.unsplash.com/photo-1551288049-bebda4e38f71?auto=format&fit=crop&w=800&q=80" },
                { id: 4, name: "Kit Redes Cisco Gold", price: 22000, cat: "Hardware", img: "https://images.unsplash.com/photo-1544197150-b99a580bb7a8?auto=format&fit=crop&w=800&q=80" },
            ];

            React.useEffect(() => {
                setProducts(MOCK_PRODUCTS);
                
                // Cargar órdenes del usuario
                const q = query(collection(db, "orders"), where("userId", "==", user.uid));
                const unsub = onSnapshot(q, (snap) => {
                    const loadedOrders = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    setOrders(loadedOrders);
                });
                return () => unsub();
            }, []);

            const addToCart = (product) => {
                setCart(prev => [...prev, product]);
            };

            const removeFromCart = (index) => {
                const newCart = [...cart];
                newCart.splice(index, 1);
                setCart(newCart);
            };

            const checkout = async () => {
                if(cart.length === 0) return;
                try {
                    const total = cart.reduce((sum, item) => sum + item.price, 0);
                    await addDoc(collection(db, "orders"), {
                        userId: user.uid,
                        userEmail: user.email,
                        items: cart,
                        total: total,
                        status: 'Pendiente', // 'Enviado', 'Entregado'
                        createdAt: serverTimestamp(),
                        deviceId: getLocalDeviceId() // Guardamos desde qué dispositivo se compró
                    });
                    setCart([]);
                    alert("Pedido Elite Confirmado. Un asesor lo procesará en breve.");
                    setView('history');
                } catch (e) {
                    console.error("Error al comprar", e);
                    alert("Error procesando pedido.");
                }
            };

            return (
                <div className="min-h-screen bg-elite-900 text-gray-200 font-sans pb-20">
                    {/* Header */}
                    <nav className="border-b border-elite-800 bg-elite-900/90 sticky top-0 z-40 backdrop-blur">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex items-center justify-between h-20">
                                <div className="flex items-center gap-4">
                                    <h1 className="text-2xl font-serif text-elite-accent tracking-widest cursor-pointer" onClick={() => setView('products')}>LUMOS ELITE</h1>
                                </div>
                                <div className="hidden md:block">
                                    <div className="ml-10 flex items-baseline space-x-8">
                                        <button onClick={() => setView('products')} className={`${view === 'products' ? 'text-white' : 'text-gray-500'} hover:text-elite-accent px-3 py-2 rounded-md text-sm font-medium uppercase tracking-wider`}>Colección</button>
                                        <button onClick={() => setView('history')} className={`${view === 'history' ? 'text-white' : 'text-gray-500'} hover:text-elite-accent px-3 py-2 rounded-md text-sm font-medium uppercase tracking-wider`}>Mis Pedidos</button>
                                        {role === 'admin' && <button onClick={() => setView('admin')} className="text-red-400 hover:text-red-300 px-3 py-2 rounded-md text-sm font-medium uppercase tracking-wider">Admin Panel</button>}
                                    </div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="relative cursor-pointer" onClick={() => setView('cart')}>
                                        <i className="fas fa-shopping-bag text-xl text-elite-accent"></i>
                                        {cart.length > 0 && <span className="absolute -top-2 -right-2 bg-red-600 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full">{cart.length}</span>}
                                    </div>
                                    <button onClick={onLogout} className="text-gray-500 hover:text-white text-xs uppercase ml-4">Salir</button>
                                </div>
                            </div>
                        </div>
                    </nav>

                    {/* Contenido Principal */}
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 fade-in">
                        
                        {/* VISTA PRODUCTOS */}
                        {view === 'products' && (
                            <div>
                                <div className="mb-10 text-center">
                                    <h2 className="text-3xl font-serif text-white mb-2">Colección Exclusiva</h2>
                                    <div className="h-1 w-20 bg-elite-accent mx-auto"></div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                                    {products.map(p => (
                                        <div key={p.id} className="group relative bg-elite-800 rounded-lg overflow-hidden shadow-lg border border-transparent hover:border-elite-accent transition-all duration-300">
                                            <div className="aspect-w-1 aspect-h-1 w-full overflow-hidden bg-gray-200 xl:aspect-w-7 xl:aspect-h-8">
                                                <img src={p.img} alt={p.name} className="h-64 w-full object-cover object-center group-hover:opacity-75 transition" />
                                            </div>
                                            <div className="p-6">
                                                <h3 className="text-sm text-elite-mute uppercase">{p.cat}</h3>
                                                <h3 className="mt-1 text-lg font-medium text-white">{p.name}</h3>
                                                <div className="mt-4 flex justify-between items-center">
                                                    <p className="text-xl font-serif text-elite-accent">{formatMoney(p.price)}</p>
                                                    <button onClick={() => addToCart(p)} className="p-2 rounded-full border border-elite-mute hover:bg-elite-accent hover:text-black transition-colors">
                                                        <i className="fas fa-plus"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* VISTA CARRITO */}
                        {view === 'cart' && (
                            <div className="max-w-2xl mx-auto">
                                <h2 className="text-2xl font-serif text-white mb-6">Bolsa de Compras</h2>
                                {cart.length === 0 ? (
                                    <div className="text-center py-20 border border-dashed border-elite-800 rounded-lg">
                                        <p className="text-gray-500">Su bolsa está vacía.</p>
                                        <button onClick={() => setView('products')} className="mt-4 text-elite-accent hover:underline">Ir a la colección</button>
                                    </div>
                                ) : (
                                    <div className="bg-elite-800 rounded-lg p-6 shadow-xl border border-elite-700">
                                        {cart.map((item, idx) => (
                                            <div key={idx} className="flex justify-between items-center py-4 border-b border-elite-700 last:border-0">
                                                <div className="flex items-center gap-4">
                                                    <img src={item.img} className="w-16 h-16 object-cover rounded" />
                                                    <div>
                                                        <h4 className="text-white font-medium">{item.name}</h4>
                                                        <p className="text-sm text-elite-accent">{formatMoney(item.price)}</p>
                                                    </div>
                                                </div>
                                                <button onClick={() => removeFromCart(idx)} className="text-red-400 hover:text-red-300"><i className="fas fa-trash"></i></button>
                                            </div>
                                        ))}
                                        <div className="mt-8 pt-6 border-t border-elite-600 flex justify-between items-center">
                                            <span className="text-xl text-gray-300">Total Estimado</span>
                                            <span className="text-3xl font-serif text-elite-accent">{formatMoney(cart.reduce((sum, i) => sum + i.price, 0))}</span>
                                        </div>
                                        <button onClick={checkout} className="w-full mt-6 gold-gradient text-black font-bold py-4 rounded hover:opacity-90 transition-opacity uppercase tracking-wider">
                                            Confirmar Pedido
                                        </button>
                                        <p className="mt-4 text-[10px] text-center text-gray-500">
                                            * Al confirmar, se generará una orden de compra vinculada a su dispositivo ID: <span className="font-mono">{getLocalDeviceId().substring(0,8)}...</span>
                                        </p>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* VISTA HISTORIAL */}
                        {view === 'history' && (
                            <div className="max-w-4xl mx-auto">
                                <h2 className="text-2xl font-serif text-white mb-6">Historial de Pedidos</h2>
                                <div className="space-y-4">
                                    {orders.map(order => (
                                        <div key={order.id} className="bg-elite-800 border border-elite-700 rounded-lg p-6 flex flex-col md:flex-row justify-between md:items-center gap-4">
                                            <div>
                                                <div className="flex items-center gap-3 mb-2">
                                                    <span className="font-mono text-xs text-elite-mute">ID: {order.id.substring(0,8).toUpperCase()}</span>
                                                    <span className={`px-2 py-0.5 rounded text-[10px] uppercase font-bold ${order.status === 'Pendiente' ? 'bg-yellow-900/50 text-yellow-500' : 'bg-green-900/50 text-green-500'}`}>{order.status}</span>
                                                </div>
                                                <p className="text-sm text-gray-300">{order.items.length} artículos • {order.createdAt?.toDate().toLocaleDateString()}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-xl font-serif text-elite-accent">{formatMoney(order.total)}</p>
                                            </div>
                                        </div>
                                    ))}
                                    {orders.length === 0 && <p className="text-gray-500 text-center">No tiene pedidos previos.</p>}
                                </div>
                            </div>
                        )}

                        {/* VISTA ADMIN (Simplificada) */}
                        {view === 'admin' && role === 'admin' && (
                            <div className="max-w-5xl mx-auto">
                                <h2 className="text-2xl font-serif text-red-400 mb-6">Panel de Administración Elite</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="bg-elite-800 p-6 rounded border border-elite-700">
                                        <h3 className="text-lg text-white mb-4">Gestión de Usuarios</h3>
                                        <p className="text-sm text-gray-400 mb-4">Para resetear el dispositivo de un usuario (permitirle cambiar de celular), ingrese su email.</p>
                                        <div className="flex gap-2">
                                            <input className="flex-1 bg-elite-900 border border-elite-600 rounded p-2 text-white" placeholder="Email del usuario" />
                                            <button className="bg-red-600 text-white px-4 rounded text-xs uppercase font-bold">Resetear ID</button>
                                        </div>
                                    </div>
                                    <div className="bg-elite-800 p-6 rounded border border-elite-700">
                                        <h3 className="text-lg text-white mb-4">Gestión de Pedidos</h3>
                                        <div className="text-sm text-gray-400">
                                            (Aquí se listarían todos los pedidos globales para cambiar estado a "Enviado")
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                    </main>
                </div>
            );
        };

        // --- APP MAIN ---
        const App = () => {
            const [user, setUser] = React.useState(null);
            const [role, setRole] = React.useState(null);
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    if (currentUser) {
                        try {
                            const docRef = doc(db, "users", currentUser.uid);
                            const docSnap = await getDoc(docRef);
                            
                            // Verificar device ID nuevamente al recargar
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                const currentId = getLocalDeviceId();
                                if (data.registeredDeviceId && data.registeredDeviceId !== currentId) {
                                    alert("Sesión cerrada: Dispositivo no coincide.");
                                    await signOut(auth);
                                    setUser(null);
                                    setLoading(false);
                                    return;
                                }
                                setUser(currentUser);
                                setRole(data.role || 'client');
                            } else {
                                // Caso borde (Auto-registro demo)
                                setUser(currentUser);
                            }
                        } catch (e) {
                            console.error(e);
                        }
                    } else {
                        setUser(null);
                        setRole(null);
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleLoginSuccess = (user, role) => {
                setUser(user);
                setRole(role);
            };

            const handleLogout = () => {
                signOut(auth);
            };

            if (loading) return <Loading />;

            if (!user) {
                return <Login onLogin={handleLoginSuccess} />;
            }

            return <Store user={user} role={role} onLogout={handleLogout} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
